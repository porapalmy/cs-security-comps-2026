rule Suspicious_Script {
    meta:
        description = "Detects pages combining executable patterns with encoding — hallmark of injected code"
        severity = "Medium"
    strings:
        $s1 = "<script>" nocase
        $s2 = /eval\s*\(/ nocase
        $s3 = /document\.write\s*\(/ nocase
        $s4 = "base64" nocase

        /* Legitimate framework markers — suppress false positives */
        $fw1 = "react" nocase
        $fw2 = "next" nocase
        $fw3 = "__webpack_require__" nocase
        $fw4 = "__esModule" nocase
        $fw5 = "__NEXT_DATA__" nocase
    condition:
        filesize < 500KB and
        all of ($s*) and
        (#s2 > 2 or #s3 > 2) and
        not (2 of ($fw*))
}

rule Executable_Header {
    meta:
        description = "Detects PE file header (Windows Executable)"
    strings:
        $mz = "MZ"
    condition:
        $mz at 0
}

rule Phishing_Keywords {
    meta:
        description = "Multiple phishing phrases on the same page"
        severity = "Medium"
    strings:
        $p1 = "verify your account" nocase
        $p2 = "update payment" nocase
        $p3 = "urgent" nocase
        $p4 = "confirm your identity" nocase
        $p5 = "suspended" nocase
        $p6 = "click here to verify" nocase
        $p7 = "enter your password" nocase
        $p8 = "unusual activity" nocase
        $p9 = "verify your identity" nocase

        /* Framework exclusions */
        $fw1 = "__NEXT_DATA__" nocase
        $fw2 = "__webpack_require__" nocase
        $fw3 = "react" nocase
    condition:
        filesize < 500KB and 3 of ($p*) and not (2 of ($fw*))
}


rule Auto_Redirect {
    meta:
        description = "Detects automatic redirection attempts"
        severity = "High"
    strings:
        $r1 = "window.location =" nocase
        $r2 = "window.location.href =" nocase
        $r3 = "window.location.replace" nocase
        $r4 = "window.location.assign" nocase
        $r5 = "http-equiv=\"refresh\"" nocase
    condition:
        filesize < 500KB and 2 of them
}

rule Hidden_Iframe {
    meta:
        description = "Detects hidden iframes often used for drive-by downloads"
        severity = "High"
    strings:
        $i1 = "<iframe" nocase
        $h1 = "width=0" nocase
        $h2 = "height=0" nocase
        $h3 = "width=\"0\"" nocase
        $h4 = "height=\"0\"" nocase
    condition:
        filesize < 500KB and $i1 and any of ($h*)
}

rule WEB_Redirect_Primitives_Medium
{
  meta:
    description = "Excessive JS redirect primitives indicating forced navigation"
    severity = "Medium"
  strings:
    $loc1 = /window\.location(\.href)?\s*=\s*/ nocase
    $loc2 = /location\.href\s*=\s*/ nocase
    $loc3 = /location\.replace\s*\(/ nocase
    $loc4 = /location\.assign\s*\(/ nocase
    $open = /window\.open\s*\(/ nocase

    /* Legitimate framework signatures — suppress false positives */
    $legit1 = "react" nocase
    $legit2 = "jQuery" nocase
    $legit3 = "__webpack_require__" nocase
    $legit4 = "googleapis" nocase
    $legit5 = "gstatic" nocase
    $legit6 = "__esModule" nocase

  condition:
    filesize < 500KB and
    not (2 of ($legit*)) and
    (4 of ($loc*) or (#open > 5))
}

rule WEB_MetaRefresh_Redirect_Medium
{
  meta:
    description = "HTML meta refresh redirect"
    severity = "Medium"
  strings:
    $meta = /<meta[^>]+http-equiv\s*=\s*["']?refresh["']?/ nocase
    $url  = /content\s*=\s*["'][^"']*url\s*=/ nocase
  condition:
    filesize < 2MB and $meta and $url
}


rule WEB_Forced_Download_High
{
  meta:
    description = "JS patterns commonly used to trigger downloads (blob, a[download], iframe, msSaveOrOpenBlob)"
    severity = "High"
  strings:
    $a_download = /createElement\s*\(\s*["']a["']\s*\)\s*;.*download\s*=/ nocase
    $click = /\.click\s*\(\s*\)/ nocase
    $blob = /\bBlob\s*\(/ nocase
    $objurl = /URL\.createObjectURL\s*\(/ nocase
    $msblob = /msSaveOrOpenBlob|msSaveBlob/ nocase
    $iframe = /createElement\s*\(\s*["']iframe["']\s*\)/ nocase
    $octet = "application/octet-stream" nocase
  condition:
    filesize < 500KB and
    (
      ($a_download and $click) or
      ($blob and $objurl and $click) or
      $msblob or
      ($iframe and $octet)
    )
}


rule WEB_Permission_Abuse_Notifications_Push_High
{
  meta:
    description = "Requests notification/push permissions and subscribes to push"
    severity = "High"
  strings:
    $notif = /Notification\.requestPermission\s*\(/ nocase
    $perm  = /navigator\.permissions\.query\s*\(/ nocase
    $push1 = /serviceWorker\.register\s*\(/ nocase
    $push2 = /pushManager\.subscribe\s*\(/ nocase
    $push3 = /showNotification\s*\(/ nocase
  condition:
    filesize < 3MB and
    ( $notif or $perm ) and (1 of ($push*))
}

rule WEB_JS_Obfuscation_Stack_Medium
{
  meta:
    description = "JS obfuscation stack: eval/new Function + charcode/atob + long encoded blob (excludes normal bundlers)"
    severity = "Medium"
  strings:
    /* Execution sinks - eval() is suspicious; bare Function() is too common in minified JS */
    $eval   = /eval\s*\(/ nocase
    $func   = /new\s+Function\s*\(/ nocase

    /* Decoder functions */
    $char   = /String\.fromCharCode\s*\(/ nocase
    $atob   = /\batob\s*\(/ nocase
    $unesc  = /\bunescape\s*\(/ nocase

    /* Long encoded payloads (raised thresholds to avoid matching minified code) */
    $hexblob = /\\x[0-9a-fA-F]{2}(\\x[0-9a-fA-F]{2}){30,}/
    $b64blob = /[A-Za-z0-9+\/]{200,}={0,2}/

    /* Bundler signatures - if present, this is normal minified JS, not obfuscation */
    $bundler1 = "__webpack_require__" nocase
    $bundler2 = "__importDefault" nocase
    $bundler3 = "__esModule" nocase
    $bundler4 = "use strict" nocase

  condition:
    filesize < 500KB and
    ( $eval or $func ) and
    (1 of ($char, $atob, $unesc)) and
    ( $hexblob or $b64blob ) and
    not (2 of ($bundler*))
}

rule Emotet_Family
{
    meta:
        family = "Emotet"
        type = "Banking Trojan"

    strings:
        $a = "Global\\EMOTET" ascii wide nocase
        $b = "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1)" ascii wide nocase

    condition:
        uint16(0) == 0x5A4D and 1 of them
}

rule Ryuk_Family
{
    meta:
        family = "Ryuk"
        type = "Ransomware"

    strings:
        $a = "RyukReadMe.txt" ascii wide nocase
        $b = ".RYK" ascii wide nocase
        $c = "Wake up!" ascii wide nocase

    condition:
        uint16(0) == 0x5A4D and 2 of them
}

rule LockBit_Family
{
    meta:
        family = "LockBit"
        type = "Ransomware"

    strings:
        $a = "LockBit" ascii wide nocase
        $b = "Restore-My-Files.txt" ascii wide nocase
        $c = ".lockbit" ascii wide nocase

    condition:
        uint16(0) == 0x5A4D and 2 of them
}

rule WannaCry_Family
{
    meta:
        family = "WannaCry"
        type = "Ransomware"

    strings:
        $a = "WannaDecryptor" ascii wide nocase
        $b = "mssecsvc.exe" ascii wide nocase
        $c = "tasksche.exe" ascii wide nocase

    condition:
        uint16(0) == 0x5A4D and 2 of them
}

rule TrickBot_Family
{
    meta:
        family = "TrickBot"
        type = "Banking Trojan"

    strings:
        $a = "TrickLoader" ascii wide nocase
        $b = "client_id" ascii wide nocase
        $c = "group_tag" ascii wide nocase

    condition:
        uint16(0) == 0x5A4D and 2 of them
}

rule QakBot_Family
{
    meta:
        family = "QakBot"
        type = "Banking Trojan"

    strings:
        $a = "CoreDll.dll" ascii wide nocase
        $b = "botnet" ascii wide nocase
        $c = "QakBot" ascii wide nocase

    condition:
        uint16(0) == 0x5A4D and 2 of them
}

rule AgentTesla_Family
{
    meta:
        family = "AgentTesla"
        type = "Spyware"

    strings:
        $a = "Mozilla/5.0 (Windows NT 6.1; WOW64)" ascii wide nocase
        $b = "SMTP" ascii wide nocase
        $c = "AgentTesla" ascii wide nocase

    condition:
        uint16(0) == 0x5A4D and 2 of them
}

rule RedLine_Family
{
    meta:
        family = "RedLine"
        type = "Infostealer"

    strings:
        $a = "RedLine" ascii wide nocase
        $b = "passwords.txt" ascii wide nocase
        $c = "wallet.dat" ascii wide nocase

    condition:
        uint16(0) == 0x5A4D and 1 of them
}

rule DarkComet_Family
{
    meta:
        family = "DarkComet"
        type = "Remote Access Trojan"

    strings:
        $a = "DarkComet" ascii wide nocase
        $b = "DC_MUTEX" ascii wide nocase
        $c = "DCRAT" ascii wide nocase

    condition:
        uint16(0) == 0x5A4D and any of them
}

rule CobaltStrike_Beacon
{
    meta:
        family = "CobaltStrike"
        type = "Post-Exploitation Framework"

    strings:
        $a = "Cobalt Strike" ascii wide nocase
        $b = "Beacon" ascii wide nocase
        $c = "ReflectiveLoader" ascii wide nocase

    condition:
        uint16(0) == 0x5A4D and 2 of them
}

