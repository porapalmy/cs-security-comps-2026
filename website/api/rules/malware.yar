rule Suspicious_Script {
    meta:
        description = "Detects suspicious script tags and executable patterns"
        severity = "Medium"
    strings:
        $s1 = "<script>" nocase
        $s2 = "eval(" nocase
        $s3 = "document.write" nocase
        $s4 = "base64" nocase
    condition:
        2 of them
}

rule Executable_Header {
    meta:
        description = "Detects PE file header (Windows Executable)"
    strings:
        $mz = "MZ"
    condition:
        $mz at 0
}

rule Phishing_Keywords {
    meta:
        description = "Keywords common in phishing"
    strings:
        $p1 = "verify your account" nocase
        $p2 = "update payment" nocase
        $p3 = "urgent" nocase
    condition:
        any of them
}





rule Auto_Redirect {
    meta:
        description = "Detects automatic redirection attempts"
        severity = "High"
    strings:
        $r1 = "window.location =" nocase
        $r2 = "window.location.href =" nocase
        $r3 = "window.location.replace" nocase
        $r4 = "window.location.assign" nocase
        $r5 = "http-equiv=\"refresh\"" nocase
    condition:
        any of them
}

rule Hidden_Iframe {
    meta:
        description = "Detects hidden iframes often used for drive-by downloads"
        severity = "High"
    strings:
        $i1 = "<iframe" nocase
        $h1 = "width=0" nocase
        $h2 = "height=0" nocase
        $h3 = "width=\"0\"" nocase
        $h4 = "height=\"0\"" nocase
    condition:
        $i1 and any of ($h*)
}

rule WEB_Redirect_Primitives_Medium
{
  meta:
    description = "Common JS redirect primitives (location replace/assign, top navigation)"
    severity = "Medium"
  strings:
    $loc1 = /window\.location(\.href)?\s*=\s*/ nocase
    $loc2 = /location\.href\s*=\s*/ nocase
    $loc3 = /location\.replace\s*\(/ nocase
    $loc4 = /location\.assign\s*\(/ nocase
    $top1 = /top\.location(\.href)?\s*=\s*/ nocase
    $open = /window\.open\s*\(/ nocase
  condition:
    filesize < 2MB and (1 of ($loc*) or $top1 or $open)
}

rule WEB_MetaRefresh_Redirect_Medium
{
  meta:
    description = "HTML meta refresh redirect"
    severity = "Medium"
  strings:
    $meta = /<meta[^>]+http-equiv\s*=\s*["']?refresh["']?/ nocase
    $url  = /content\s*=\s*["'][^"']*url\s*=/ nocase
  condition:
    filesize < 2MB and $meta and $url
}


rule WEB_Forced_Download_High
{
  meta:
    description = "JS patterns commonly used to trigger downloads (blob, a[download], iframe, msSaveOrOpenBlob)"
    severity = "High"
  strings:
    $a_download = /createElement\s*\(\s*["']a["']\s*\)\s*;.*download\s*=/ nocase
    $click = /\.click\s*\(\s*\)/ nocase
    $blob = /\bBlob\s*\(/ nocase
    $objurl = /URL\.createObjectURL\s*\(/ nocase
    $msblob = /msSaveOrOpenBlob|msSaveBlob/ nocase
    $iframe = /createElement\s*\(\s*["']iframe["']\s*\)/ nocase
    $octet = "application/octet-stream" nocase
  condition:
    filesize < 3MB and
    (
      ($a_download and $click) or
      ($blob and $objurl and $click) or
      $msblob or
      ($iframe and $octet)
    )
}


rule WEB_Permission_Abuse_Notifications_Push_High
{
  meta:
    description = "Requests notification/push permissions and subscribes to push"
    severity = "High"
  strings:
    $notif = /Notification\.requestPermission\s*\(/ nocase
    $perm  = /navigator\.permissions\.query\s*\(/ nocase
    $push1 = /serviceWorker\.register\s*\(/ nocase
    $push2 = /pushManager\.subscribe\s*\(/ nocase
    $push3 = /showNotification\s*\(/ nocase
  condition:
    filesize < 3MB and
    ( $notif or $perm ) and (1 of ($push*))
}

rule WEB_JS_Obfuscation_Stack_Medium
{
  meta:
    description = "Common JS obfuscation stack: eval/Function + charcode/atob + long encoded blob"
    severity = "Medium"
  strings:
    $eval = /eval\s*\(/ nocase
    $func = /new\s+Function\s*\(|Function\s*\(/ nocase
    $char = /String\.fromCharCode\s*\(/ nocase
    $atob = /\batob\s*\(/ nocase
    $unesc = /\bunescape\s*\(/ nocase
    $hexblob = /\\x[0-9a-fA-F]{2}(\\x[0-9a-fA-F]{2}){20,}/
    $b64blob = /[A-Za-z0-9+\/]{120,}={0,2}/
  condition:
    filesize < 3MB and
    ( $eval or $func ) and (1 of ($char, $atob, $unesc)) and ( $hexblob or $b64blob )
}
